<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMT BIMA - Cloud System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- STYLE DASAR --- */
        :root { --primary: #0f3d3e; --secondary: #c4a962; --bg: #f4f7f6; --text: #333; --sidebar-width: 260px; --transition: all 0.3s ease; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; outline: none; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; }
        .hidden { display: none !important; }

        /* LOADING OVERLAY */
        #loading-screen { position: fixed; inset: 0; background: #0f3d3e; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; transition: 0.5s; }
        .loader { border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid var(--secondary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI COMPONENTS */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #c0392b; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-ghost { background: transparent; color: var(--primary); font-size: 1.4rem; cursor: pointer; border: none; margin-right: 15px; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eee; }
        .form-vertical { display: flex; flex-direction: column; gap: 15px; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.95rem; background: #fafafa; transition: 0.3s; }
        .form-control:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(15, 61, 62, 0.1); }

        /* GATEWAY */
        #gateway { position: fixed; inset: 0; background: linear-gradient(rgba(5, 25, 26, 0.85), rgba(5, 25, 26, 0.9)), url('https://images.unsplash.com/photo-1556761175-5973dc0f32e7?q=80&w=1600&auto=format&fit=crop'); background-size: cover; background-position: center; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .gateway-grid { display: flex; gap: 20px; margin-top: 40px; flex-wrap: wrap; justify-content: center; }
        .g-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 30px; border-radius: 16px; width: 200px; text-align: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .g-card:hover { transform: translateY(-10px); background: rgba(255,255,255,0.2); border-color: var(--secondary); }
        #login-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; }
        
        /* APP LAYOUT */
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: var(--sidebar-width); background: var(--primary); color: white; height: 100vh; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; z-index: 1000; transition: var(--transition); box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        .sidebar.minimized { width: 80px; }
        .sidebar.minimized .hide-mini { display: none; }
        .sidebar.minimized .sidebar-brand { justify-content: center; padding: 0; }
        .sidebar.minimized .menu-link { justify-content: center; padding: 15px 0; }
        .sidebar-brand { height: 90px; display: flex; align-items: center; padding: 0 25px; gap: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-menu { flex: 1; padding-top: 20px; overflow-y: auto; overflow-x: hidden; }
        .menu-link { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; opacity: 0.8; transition: 0.2s; font-size: 0.95rem; white-space: nowrap; }
        .menu-link:hover, .menu-link.active { background: rgba(255,255,255,0.1); opacity: 1; border-left: 4px solid var(--secondary); }
        .main-content { margin-left: var(--sidebar-width); flex: 1; width: calc(100% - var(--sidebar-width)); background: #f8f9fa; transition: var(--transition); }
        .sidebar.minimized ~ .main-content { margin-left: 80px; width: calc(100% - 80px); }
        .topbar { height: 90px; background: white; padding: 0 40px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 900; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        
        /* TABLES */
        .table-responsive { width: 100%; overflow-x: auto; margin-top: 10px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 12px; background: #eee; font-weight: 600; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #ddd; font-size: 0.9rem; white-space: nowrap; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .bg-pending { background: #ffeeba; color: #856404; }
        .bg-success { background: #d4edda; color: #155724; }

        /* STATUS SYNC */
        #sync-status { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 50px; font-size: 0.8rem; z-index: 9999; display: flex; align-items: center; gap: 10px; transition: 0.3s; opacity: 0; pointer-events: none; }
        #sync-status.active { opacity: 1; }

        /* ID CARD & PRINT */
        .id-card { width: 85.6mm; height: 53.98mm; border: 1px solid #000; border-radius: 5px; position: relative; background: white; overflow: hidden; page-break-inside: avoid; margin-bottom: 10px; display: none; }
        .id-header { background: var(--primary); height: 15mm; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; text-align: center; font-size: 10pt; }
        .id-body { padding: 5px; display: flex; align-items: center; gap: 10px; height: 30mm; }
        .id-photo { width: 20mm; height: 25mm; border: 1px solid #333; background: #eee; object-fit: cover; }
        .id-details { font-size: 8pt; line-height: 1.2; }
        .id-footer { position: absolute; bottom: 5px; width: 100%; text-align: center; }
        .barcode { height: 8mm; }

        @media print {
            @page { size: A4; margin: 10mm; }
            .no-print, .sidebar, .topbar, #gateway, #loading-screen, #login-modal, .btn, #sync-status { display: none !important; }
            .main-content { margin: 0; width: 100%; padding: 0; background: white; }
            #printable-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; }
            body { font-family: 'Times New Roman', serif; font-size: 11pt; color: #000; -webkit-print-color-adjust: exact; }
            
            .bank-header { display: flex; align-items: center; border-bottom: 3px double #000; padding-bottom: 10px; margin-bottom: 20px; }
            .bank-logo { width: 80px; height: 80px; object-fit: contain; margin-right: 20px; }
            .bank-info { flex: 1; text-align: center; }
            .bank-info h1 { font-size: 18pt; font-weight: 900; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
            .doc-title { text-align: center; margin-bottom: 20px; text-transform: uppercase; }
            .doc-title h2 { font-size: 14pt; font-weight: bold; text-decoration: underline; margin: 0; }
            .doc-body { text-align: justify; line-height: 1.3; }
            .bio-container { display: flex; gap: 15px; margin: 15px 0; border: 1px solid #000; padding: 10px; align-items: flex-start; }
            .photo-frame { width: 30mm; height: 40mm; border: 1px solid #000; background: #f0f0f0; display: flex; align-items: center; justify-content: center; }
            .photo-frame img { width: 100%; height: 100%; object-fit: cover; }
            .bio-text table { width: 100%; border: none; }
            .bio-text td { border: none; padding: 2px 0; vertical-align: top; }
            .fin-table { width: 100%; border-collapse: collapse; margin: 15px 0; border: 1px solid #000; }
            .fin-table td, .fin-table th { border: 1px solid #000; padding: 6px 10px; }
            .fin-table tr:first-child td { background-color: #eee !important; font-weight: bold; text-align: center; }
            .signatures { display: grid; grid-template-columns: 1fr 1fr 1fr; margin-top: 40px; page-break-inside: avoid; gap: 10px; }
            .sig-box { text-align: center; }
            .sig-line { border-bottom: 1px solid #000; margin-top: 70px; font-weight: bold; width: 80%; margin: auto; }
            .id-card-print { display: block !important; margin: 20px auto; border: 1px solid #000; }
        }
        #printable-area { display: none; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader"></div>
        <h3 id="loading-text">Menghubungkan ke Database...</h3>
    </div>

    <div id="sync-status"><i class="fas fa-check"></i> Disimpan di Cloud</div>

    <div id="gateway" class="hidden">
        <div style="text-align:center; margin-bottom:40px;">
            <img id="gw-logo" src="" style="width: 120px; height: 120px; border-radius: 50%; border: 4px solid white; margin-bottom:20px; padding: 10px; background: rgba(255,255,255,0.15); object-fit: contain; backdrop-filter: blur(5px);">
            <h1 id="gw-nama" style="font-family: 'Playfair Display'; font-size: 2.5rem; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 2px 10px rgba(0,0,0,0.5); margin: 0; margin-bottom:10px;">BMT SYSTEM</h1>
            <p id="gw-izin" style="font-size: 1rem; opacity: 0.9; font-weight: 300; letter-spacing: 1px;">Izin No: ...</p>
        </div>
        <div class="gateway-grid">
            <div class="g-card" onclick="openLogin('induk')"><i class="fas fa-university fa-3x" style="margin-bottom:15px;"></i><br><b>INDUK PUSAT</b><br><span>Admin, Sekretaris, Bendahara</span></div>
            <div class="g-card" onclick="openLogin('sps')"><i class="fas fa-hand-holding-usd fa-3x" style="margin-bottom:15px;"></i><br><b>Simpan Pinjam</b><br><span>Unit Syariah</span></div>
            <div class="g-card" onclick="openLogin('kms')"><i class="fas fa-motorcycle fa-3x" style="margin-bottom:15px;"></i><br><b>Kredit Motor</b><br><span>Unit Syariah</span></div>
            <div class="g-card" onclick="openLogin('gadai')"><i class="fas fa-balance-scale fa-3x" style="margin-bottom:15px;"></i><br><b>Gadai Syariah</b><br><span>Unit Syariah</span></div>
        </div>
        <div style="margin-top: 30px;">
            <button onclick="forceReload()" style="background:transparent; border:1px solid rgba(255,255,255,0.3); color:rgba(255,255,255,0.8); padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.7rem;">REFRESH DATA</button>
        </div>
    </div>

    <div id="login-modal">
        <div class="card" style="width: 380px; text-align: center;">
            <h3 id="login-title" style="color:var(--primary);">Login</h3><br>
            <div class="form-vertical">
                <input type="text" id="username" class="form-control" placeholder="Username">
                <input type="password" id="password" class="form-control" placeholder="Password">
                <button class="btn btn-primary" onclick="prosesLogin()" style="justify-content:center;">MASUK</button>
                <button class="btn" onclick="document.getElementById('login-modal').style.display='none'" style="justify-content:center;">Batal</button>
            </div>
        </div>
    </div>

    <div id="app" class="app-container hidden">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <img id="sb-logo" src="" style="width:40px; border-radius:50%; object-fit:cover;">
                <div class="hide-mini" style="line-height:1.2; margin-left:10px;"><div id="sb-nama" style="font-weight:bold; font-size:0.9rem;">BMT NAME</div><small style="opacity:0.7;">INTEGRATED</small></div>
            </div>
            <div id="menu-container" class="sidebar-menu"></div>
            <div style="padding: 25px;">
                <button onclick="logoutManual()" class="btn" style="width:100%; background:rgba(255,255,255,0.1); color:#ff8787;"><i class="fas fa-power-off"></i> <span class="hide-mini">Keluar</span></button>
            </div>
        </aside>
        <main class="main-content">
            <header class="topbar">
                <div style="display:flex; align-items:center;"><button class="btn-ghost" onclick="document.getElementById('sidebar').classList.toggle('minimized')"><i class="fas fa-bars"></i></button><h2 id="page-title" style="color:var(--primary); margin:0;">Dashboard</h2></div>
                <div style="text-align:right;"><div id="user-role-display" style="font-weight:bold;">Role</div><small id="user-name-display">User</small></div>
            </header>
            <div id="content-body" style="padding: 40px;"></div>
        </main>
    </div>

    <div id="printable-area"></div>

    <script>
        // ================================================================
        // KONFIGURASI DATABASE (WAJIB DIISI)
        // Ganti teks di bawah dengan URL Google Apps Script Anda
        // ================================================================
        const DATABASE_URL = "https://script.google.com/macros/s/AKfycbzoo3oSDhhHfqRTRsztU2HcNplcJUNIdJwXEdqwatdMooZrAFrDFNmCb285BD9yWCUNmw/exec"; 
        // Contoh: "https://script.google.com/macros/s/AKfycbx.../exec"
        // ================================================================

        // DATA DEFAULT (Hanya dipakai jika Database Kosong)
        const defaultUsers = [
            {user:'admin',role:'admin',app:'induk',password:'123'}, 
            {user:'bendahara',role:'bendahara',app:'induk',password:'123'},
            {user:'sekretaris',role:'sekretaris',app:'induk',password:'123'}, 
            {user:'anggota',role:'anggota',app:'induk',password:'123'},
            {user:'manager',role:'manager',app:'unit',password:'123'}, 
            {user:'marketing',role:'marketing',app:'unit',password:'123'},
            {user:'accounting',role:'accounting',app:'unit',password:'123'}
        ];
        const defaultConfig = {
            nama: "BMT BINA INSAN ASSIROT", izin: "518/BH/KWK/2025", alamat: "Jl. Jendral Sudirman No. 45", wa: "08123456789", email: "info@bmt.co.id", 
            logo: "https://cdn-icons-png.flaticon.com/512/2317/2317968.png", wallpaper: "https://images.unsplash.com/photo-1556761175-5973dc0f32e7?q=80&w=1600&auto=format&fit=crop",
            struktur: { ketua: "H. Abdullah", sekretaris: "Siti Aminah", bendahara: "Rudi Hartono" }, 
            visi: "Menjadi Lembaga Keuangan Syariah Terdepan", misi: "1. Transaksi Syariah Murni\n2. Pelayanan Prima",
            unit_leads: {sps: "Bpk. Budi", kms: "Ibu Ani", gadai: "Bpk. Cipto"},
            shu: { profit: 150000000, p_tetap: 50, p_nasabah: 20 },
            codes: { sps: 'SPS', kms: 'KMS', gadai: 'GS' }, margins: { sps: 10, kms: 20, gadai: 5 }, limits: { sps: 100, kms: 100, gadai: 100 },
            templates: { sps: "Pasal 1: Akad Mudharabah (Bagi Hasil).\nPasal 2: Nisbah bagi hasil 60:40.", kms: "Pasal 1: Akad Murabahah (Jual Beli).\nPasal 2: Harga jual fixed hingga lunas.", gadai: "Pasal 1: Akad Rahn (Gadai).\nPasal 2: Biaya Ijaroh pemeliharaan barang." }
        };

        // GLOBAL VARIABLES
        let settings = defaultConfig;
        let dbUsers = defaultUsers;
        let dbNasabah = [], dbSarpras = [], dbSurat = [], dbDana = [], dbPresensi = [];
        let activeApp = '', activeUser = null;

        // --- INIT & CLOUD SYNC ---
        window.onload = async function() {
            if (DATABASE_URL && DATABASE_URL !== "ISI_URL_GOOGLE_SCRIPT_DISINI") {
                await loadFromCloud();
            } else {
                alert("PENTING: Anda belum memasukkan URL Google Script di dalam kode. Aplikasi berjalan mode offline (Reset saat refresh).");
                initApp();
            }
        };

        async function loadFromCloud() {
            try {
                let res = await fetch(DATABASE_URL);
                let data = await res.json();
                
                // Jika data kosong (baru pertama kali), pakai default
                if (!data.users) {
                    console.log("Database kosong, menggunakan data default.");
                    initApp();
                    saveToCloud(); // Push default data to cloud
                } else {
                    settings = data.config || defaultConfig;
                    dbUsers = data.users || defaultUsers;
                    dbNasabah = data.nasabah || [];
                    dbSarpras = data.sarpras || [];
                    dbSurat = data.surat || [];
                    dbDana = data.dana || [];
                    dbPresensi = data.presensi || [];
                    initApp();
                }
            } catch(e) {
                alert("Gagal koneksi ke Database! Cek internet atau URL.");
                initApp(); // Fallback
            }
        }

        async function saveToCloud() {
            if (!DATABASE_URL || DATABASE_URL === "ISI_URL_GOOGLE_SCRIPT_DISINI") return;
            
            showSyncStatus(true);
            let payload = {
                config: settings, users: dbUsers, nasabah: dbNasabah,
                sarpras: dbSarpras, surat: dbSurat, dana: dbDana, presensi: dbPresensi
            };
            
            try {
                await fetch(DATABASE_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                showSyncStatus(false);
            } catch(e) {
                console.error("Save failed", e);
            }
        }

        function initApp() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('gateway').classList.remove('hidden');
            renderIdentitas();
        }

        function showSyncStatus(isSaving) {
            const el = document.getElementById('sync-status');
            if(isSaving) {
                el.innerHTML = '<i class="fas fa-sync fa-spin"></i> Menyimpan...';
                el.classList.add('active');
            } else {
                el.innerHTML = '<i class="fas fa-check"></i> Data Aman';
                setTimeout(() => el.classList.remove('active'), 2000);
            }
        }

        function forceReload() { location.reload(); }

        // --- CORE FUNCTIONS ---
        function renderIdentitas() {
            document.getElementById('gw-nama').innerText = settings.nama;
            document.getElementById('gw-izin').innerText = "Izin No: " + settings.izin;
            document.getElementById('sb-nama').innerText = settings.nama;
            document.getElementById('gw-logo').src = settings.logo;
            document.getElementById('sb-logo').src = settings.logo;
            let wp = settings.wallpaper || defaultConfig.wallpaper;
            document.getElementById('gateway').style.background = `linear-gradient(rgba(5, 25, 26, 0.85), rgba(5, 25, 26, 0.9)), url('${wp}') no-repeat center center/cover`;
        }

        function openLogin(app) { activeApp=app; document.getElementById('login-title').innerText="Login "+app.toUpperCase(); document.getElementById('login-modal').style.display='flex'; }
        function logoutManual() { document.getElementById('app').classList.add('hidden'); document.getElementById('gateway').classList.remove('hidden'); activeUser=null; document.getElementById('username').value=''; document.getElementById('password').value=''; }
        
        function prosesLogin() {
            let u = document.getElementById('username').value.toLowerCase(); let p = document.getElementById('password').value;
            let user = dbUsers.find(x=>x.user===u);
            if(!user || (user.password && user.password !== p)) return alert("Login Gagal!");
            if((activeApp==='induk' && user.app!=='induk') || (activeApp!=='induk' && user.app!=='unit')) return alert("Akses Ditolak");
            activeUser = { user:u, role:user.role.toUpperCase() };
            document.getElementById('login-modal').style.display='none'; document.getElementById('gateway').classList.add('hidden'); document.getElementById('app').classList.remove('hidden');
            let r=document.documentElement; if(activeApp==='sps')r.style.setProperty('--primary','#2c3e50'); else if(activeApp==='kms')r.style.setProperty('--primary','#d35400'); else if(activeApp==='gadai')r.style.setProperty('--primary','#8e44ad'); else r.style.setProperty('--primary','#0f3d3e');
            renderMenu();
        }

        function renderMenu() {
            document.getElementById('user-role-display').innerText=activeUser.role; document.getElementById('user-name-display').innerText=activeUser.user;
            let m=document.getElementById('menu-container'); m.innerHTML='';
            const add=(id,i,t)=>m.innerHTML+=`<div class="menu-link" onclick="page('${id}')"><i class="${i}"></i> <span class="hide-mini">${t}</span></div>`;
            
            if(activeApp==='induk') {
                add('home','fas fa-chart-line','Dashboard');
                if(activeUser.role==='ADMIN') { 
                    add('edit_profile_lembaga','fas fa-university','Edit Profil'); 
                    add('manage_shu','fas fa-coins','Atur SHU'); 
                    add('users','fas fa-users-cog','Kelola User'); 
                    add('identitas','fas fa-cog','Identitas & Tampilan'); 
                    add('surat_induk','fas fa-envelope','Surat Umum'); 
                    add('template_akad','fas fa-file-contract','Template Akad');
                    add('config_surat','fas fa-sort-numeric-up','Config No Surat');
                }
                if(['SEKRETARIS','ADMIN'].includes(activeUser.role)) { 
                    add('surat_induk','fas fa-envelope','Surat Menyurat'); 
                    add('cetak_akad','fas fa-print','Cetak Akad'); 
                    add('sarpras_approval','fas fa-check-square','Approval Sarpras'); 
                    add('laporan_pusat','fas fa-folder-open','Pusat Laporan'); 
                    add('monitoring_pegawai','fas fa-users','Monitoring Pegawai'); 
                }
                if(['BENDAHARA','ADMIN'].includes(activeUser.role)) { add('laporan_keuangan','fas fa-wallet','Laporan Keuangan'); add('distribusi_modal','fas fa-hand-holding-usd','Penyaluran Modal'); }
            } else {
                add('home','fas fa-tachometer-alt','Dashboard');
                if(['MANAGER','ACCOUNTING','MARKETING'].includes(activeUser.role)) add('presensi_harian','fas fa-clock','Presensi Harian'); 
                if(activeUser.role==='MARKETING') { add('input','fas fa-user-plus','Input Nasabah'); add('cetak','fas fa-print','Cetak'); }
                if(activeUser.role==='MANAGER') { add('approval','fas fa-check-double','Approval'); add('req_sarpras','fas fa-box-open','Req Sarpras'); add('setting_margin','fas fa-percent','Setting Margin'); }
                if(activeUser.role==='ACCOUNTING') { add('billing','fas fa-file-invoice','Billing'); add('dana_unit','fas fa-coins','Manajemen Dana'); }
            }
            page('home');
        }

        // --- PAGE RENDERER ---
        function page(id) {
            let b=document.getElementById('content-body'); let t=document.getElementById('page-title'); b.innerHTML='';
            
            // ADMIN: IDENTITAS (SIMPLIFIED - URL HARDCODED)
            if(id==='identitas') {
                t.innerText="Identitas & Tampilan";
                b.innerHTML=`<div class="card"><h4>Identitas Lembaga</h4><div class="form-vertical"><label>Nama BMT</label><input id="s-nm" class="form-control" value="${settings.nama}"><label>Nomor Izin</label><input id="s-iz" class="form-control" value="${settings.izin}"><label>Alamat Lengkap</label><input id="s-al" class="form-control" value="${settings.alamat}"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>Email</label><input id="s-em" class="form-control" value="${settings.email}"></div><div><label>WA</label><input id="s-wa" class="form-control" value="${settings.wa}"></div></div><hr><label><b>Upload Logo Baru:</b></label><input type="file" id="f-logo" onchange="previewImage(this, 's-lg')"><input type="hidden" id="s-lg" value="${settings.logo}"><label><b>Upload Wallpaper Login:</b></label><input type="file" id="f-wall" onchange="previewImage(this, 's-wall')"><input type="hidden" id="s-wall" value="${settings.wallpaper || ''}"><button class="btn btn-primary" onclick="saveID()">Simpan & Update Cloud</button></div></div>`;
            }
            
            // ... (PAGE LOGIC - SAME AS BEFORE, JUST LINKED TO SAVE TO CLOUD) ...
            else if(id==='home') {
                t.innerText="Dashboard";
                if(activeApp==='induk') {
                    let prof=parseInt(settings.shu.profit); let totalAsset = dbDana.reduce((a,b)=>a+parseInt(b.amount),0); 
                    b.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px,1fr));gap:20px;margin-bottom:20px"><div class="card" style="background:var(--primary);color:white"><h3>SHU Berjalan</h3><h2>Rp ${prof.toLocaleString()}</h2></div><div class="card" style="background:var(--secondary);color:white"><h3>Total Aset</h3><h2>Rp ${totalAsset.toLocaleString()}</h2></div></div><div class="card"><h3>Visi & Misi</h3><p><b>Visi:</b> ${settings.visi}</p><p><b>Misi:</b><br>${settings.misi.replace(/\n/g,'<br>')}</p></div><div class="card"><h3>Struktur Organisasi</h3><div class="org-chart"><div class="org-box">Ketua<br>${settings.struktur.ketua}</div><br><div class="org-line"></div><br><div style="display:flex;justify-content:center;gap:20px"><div class="org-box">Sekretaris<br>${settings.struktur.sekretaris}</div><div class="org-box">Bendahara<br>${settings.struktur.bendahara}</div></div><br><div class="org-line"></div><br><div style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap"><div class="org-box">SPS: ${settings.unit_leads?.sps||'-'}</div><div class="org-box">KMS: ${settings.unit_leads?.kms||'-'}</div><div class="org-box">Gadai: ${settings.unit_leads?.gadai||'-'}</div></div></div></div>`;
                } else {
                    let activeClients = dbNasabah.filter(x => x.unit === activeApp && x.status === 'Approved'); let totalPlafond = activeClients.reduce((a, b) => a + parseInt(b.plafond), 0); b.innerHTML = `<div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;"><div class="card" style="background:var(--primary); color:white;"><h3>Nasabah Aktif</h3><h1 style="margin:10px 0;">${activeClients.length}</h1></div><div class="card" style="background:var(--secondary); color:white;"><h3>Perputaran Uang</h3><h1 style="margin:10px 0;">Rp ${totalPlafond.toLocaleString()}</h1></div></div>`;
                }
            }
            // (GENERIC PAGES)
            else if(id==='input') { t.innerText="Input Nasabah"; let ex=activeApp==='kms'?`<input id="i-dp" class="form-control" placeholder="DP (Rp)">`: (activeApp==='gadai'?`<input id="i-jam" class="form-control" placeholder="Barang Jaminan">`:''); b.innerHTML=`<div class="card" style="max-width:600px"><div class="form-vertical"><input id="i-nm" class="form-control" placeholder="Nama Lengkap"><input id="i-nik" class="form-control" placeholder="NIK (KTP)"><input id="i-al" class="form-control" placeholder="Alamat Domisili"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><input id="i-wa" class="form-control" placeholder="No. WA"><input id="i-em" class="form-control" placeholder="Email (Opsional)"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><input id="i-pl" class="form-control" placeholder="Plafond (Rp)"><input id="i-tn" class="form-control" placeholder="Tenor (Bulan)"></div>${ex}<hr><div class="form-group"><label>Foto KTP</label><input type="file"></div><div class="form-group"><label>Foto Ket. Kerja / Usaha</label><input type="file"></div><div class="form-group"><label>Foto Wajah (Untuk Akad)</label><input type="file" onchange="readFoto(this)"><img id="prev-foto" style="width:80px;display:none;margin-top:5px"></div><button class="btn btn-primary" onclick="subNas()">Simpan Data</button></div></div>`; }
            else if(id==='users') { t.innerText="Manajemen Pengguna"; let rows=dbUsers.map((u,i)=>`<tr><td>${u.user}</td><td>${u.role}</td><td>${u.app}</td><td><button class="btn btn-danger btn-sm" onclick="delUser(${i})">Del</button></td></tr>`).join(''); b.innerHTML=`<div class="card" style="max-width:600px;"><h4>Tambah User Baru</h4><div class="form-vertical"><input id="n-u" class="form-control" placeholder="Username Baru"><select id="n-r" class="form-control"><option value="anggota">Anggota</option><option value="admin">Admin</option><option value="bendahara">Bendahara</option><option value="sekretaris">Sekretaris</option><option value="marketing">Marketing</option><option value="manager">Manager</option><option value="accounting">Accounting</option></select><input id="n-p" type="text" class="form-control" placeholder="Password (Wajib Diisi)"><button class="btn btn-primary" onclick="addUser()">Simpan User</button></div></div><div class="card"><div class="table-responsive"><table><thead><tr><th>User</th><th>Role</th><th>App</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; }
            else if(id==='monitoring_pegawai') { t.innerText="Monitoring"; let logs = dbPresensi.map(p => `<tr><td>${new Date(p.time).toLocaleString()}</td><td>${p.user}</td><td>${p.type}</td><td>${p.loc}</td><td>${p.ket||'-'}</td></tr>`).join(''); let users = dbUsers.filter(u=>['manager','marketing','accounting'].includes(u.role)).map(u=>`<tr><td>${u.user}</td><td>${u.role}</td><td><button class="btn btn-sm btn-primary" onclick="printIDCard('${u.user}','${u.role}')">ID Card</button></td></tr>`).join(''); b.innerHTML=`<div class="card"><h3>Laporan Kehadiran</h3><button class="btn btn-success" onclick="printLaporanPresensi()">Cetak PDF</button><div class="table-responsive"><table><thead><tr><th>Waktu</th><th>Nama</th><th>Status</th><th>Lokasi</th><th>Ket</th></tr></thead><tbody>${logs}</tbody></table></div></div><div class="card"><h3>Cetak Identitas Pegawai</h3><div class="table-responsive"><table><thead><tr><th>Nama</th><th>Jabatan</th><th>Aksi</th></tr></thead><tbody>${users}</tbody></table></div></div>`; }
            else if(id==='laporan_pusat') { t.innerText="Pusat Laporan"; let sar=dbSarpras.map((s,i)=>`<tr><td>${s.unit}</td><td>${s.item}</td><td>${s.status}</td><td>${s.status=='Pending'?`<button class="btn btn-success btn-sm" onclick="accSarpras(${i})">ACC</button>`:''}</td></tr>`).join(''); b.innerHTML=`<div class="card"><h3>Laporan & Database</h3><div style="display:flex;gap:10px;margin-bottom:20px"><button class="btn btn-success" onclick="printLaporanSarpras()">Laporan Sarpras</button><button class="btn btn-primary" onclick="printDatabaseNasabah()">Database Nasabah</button></div><div class="table-responsive"><table><thead><tr><th>Unit</th><th>Item</th><th>Status</th><th>Aksi</th></tr></thead><tbody>${sar}</tbody></table></div></div>`; }
            else if(id==='edit_profile_lembaga') { t.innerText="Edit Profil Lembaga"; b.innerHTML=`<div class="card"><h4>Visi & Misi</h4><div class="form-vertical"><label>Visi</label><textarea id="e-visi" class="form-control">${settings.visi}</textarea><label>Misi</label><textarea id="e-misi" class="form-control" style="height:100px">${settings.misi}</textarea></div></div><div class="card"><h4>Struktur Pimpinan</h4><div class="form-vertical"><label>Ketua</label><input id="e-ketua" class="form-control" value="${settings.struktur.ketua}"><label>Sekretaris</label><input id="e-sekretaris" class="form-control" value="${settings.struktur.sekretaris}"><label>Bendahara</label><input id="e-bendahara" class="form-control" value="${settings.struktur.bendahara}"></div></div><div class="card"><h4>Pimpinan Unit</h4><div class="form-vertical"><label>Manager SPS</label><input id="e-u-sps" class="form-control" value="${settings.unit_leads?.sps||''}"><label>Manager KMS</label><input id="e-u-kms" class="form-control" value="${settings.unit_leads?.kms||''}"><label>Manager Gadai</label><input id="e-u-gadai" class="form-control" value="${settings.unit_leads?.gadai||''}"><button class="btn btn-primary" onclick="saveProfilLembaga()">Simpan Profil</button></div></div>`; }
            else if(id==='presensi_harian') { t.innerText="Presensi Harian"; b.innerHTML=`<div class="card" style="text-align:center"><h3>Halo, ${activeUser.user}</h3><p id="clock-display" style="font-size:2rem;font-weight:bold"></p><div style="display:flex;justify-content:center;gap:20px;margin:20px 0;"><button class="btn btn-success" onclick="doPresensi('Masuk')" style="padding:15px 30px"><i class="fas fa-sign-in-alt"></i> Masuk (08:00)</button><button class="btn btn-danger" onclick="doPresensi('Pulang')" style="padding:15px 30px"><i class="fas fa-sign-out-alt"></i> Pulang (14:00)</button></div></div><div class="card"><h4>Izin / Sakit / Libur</h4><div class="form-vertical"><select id="p-status" class="form-control"><option value="Izin">Izin</option><option value="Sakit">Sakit</option><option value="Libur">Libur</option></select><input id="p-ket" class="form-control" placeholder="Keterangan"><button class="btn btn-warning" onclick="doPresensi('Izin')">Kirim Keterangan</button></div></div>`; setInterval(()=>document.getElementById('clock-display').innerText=new Date().toLocaleTimeString(),1000); }
            else if(id==='template_akad') { t.innerText="Edit Template Akad"; b.innerHTML = `<div class="card"><h4>Atur Isi Surat Akad per Unit</h4><div class="form-vertical"><label>SPS</label><textarea id="t-sps" class="form-control" style="height:100px">${settings.templates.sps}</textarea><label>KMS</label><textarea id="t-kms" class="form-control" style="height:100px">${settings.templates.kms}</textarea><label>GS</label><textarea id="t-gadai" class="form-control" style="height:100px">${settings.templates.gadai}</textarea><button class="btn btn-primary" onclick="saveAllTemplates()">Simpan Semua Template</button></div></div>`; }
            else if(id==='cetak_akad') { t.innerText="Cetak Ulang Akad"; let rows = dbNasabah.filter(x => x.status === 'Approved').map(x => `<tr><td>${x.unit.toUpperCase()}</td><td>${x.nama}</td><td>${x.noSurat}</td><td><button class="btn btn-primary btn-sm" onclick="printAkad(${x.id})">Cetak</button></td></tr>`).join(''); b.innerHTML = `<div class="card"><h4>Database Akad Nasabah</h4><div class="table-responsive"><table><thead><tr><th>Unit</th><th>Nama</th><th>No Surat</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; }
            else if(id==='distribusi_modal') { t.innerText="Penyaluran & Limit"; let pendings = dbDana.filter(d => d.status === 'Pending').map((d,i) => `<tr><td>${new Date(d.date).toLocaleDateString()}</td><td>${d.unit.toUpperCase()}</td><td>Rp ${parseInt(d.amount).toLocaleString()}</td><td><button class="btn btn-sm btn-success" onclick="accDana('${d.id}')">ACC</button></td></tr>`).join(''); let history = dbDana.filter(d => d.status === 'Approved').map(d => `<tr><td>${new Date(d.date).toLocaleDateString()}</td><td>${d.unit.toUpperCase()}</td><td>Rp ${parseInt(d.amount).toLocaleString()}</td><td>${d.desc}</td></tr>`).join(''); b.innerHTML = `<div class="card" style="border-left: 5px solid red;"><h4>Batasan Penggunaan Dana</h4><div class="form-vertical"><div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;"><div><label>Limit SPS (%)</label><input type="number" id="lim-sps" class="form-control" value="${settings.limits.sps}"></div><div><label>Limit KMS (%)</label><input type="number" id="lim-kms" class="form-control" value="${settings.limits.kms}"></div><div><label>Limit Gadai (%)</label><input type="number" id="lim-gadai" class="form-control" value="${settings.limits.gadai}"></div></div><button class="btn btn-danger" onclick="saveLimits()">Simpan & Kunci</button></div></div><div class="card"><h4>Approval & Penyaluran <button class="btn btn-sm btn-primary" style="float:right" onclick="printLaporanPenyaluran()">Cetak Laporan</button></h4><div class="table-responsive"><table><thead><tr><th>Tgl</th><th>Unit</th><th>Nominal</th><th>Aksi</th></tr></thead><tbody>${pendings.length?pendings:'<tr><td colspan="4">Tidak ada pengajuan.</td></tr>'}</tbody></table></div><br><h4>Input Manual</h4><div class="form-vertical"><select id="m-unit" class="form-control"><option value="sps">Simpan Pinjam</option><option value="kms">Kredit Motor</option><option value="gadai">Gadai Syariah</option></select><input id="m-amount" type="number" class="form-control" placeholder="Nominal (Rp)"><input id="m-desc" class="form-control" placeholder="Ket"><button class="btn btn-primary" onclick="saveModal('Approved')">Salurkan</button></div></div><div class="card"><h4>Riwayat</h4><div class="table-responsive"><table><thead><tr><th>Tgl</th><th>Unit</th><th>Nominal</th><th>Ket</th></tr></thead><tbody>${history}</tbody></table></div></div>`; }
            else if(id==='dana_unit') { t.innerText="Manajemen Dana"; let totalMasuk = dbDana.filter(x => x.unit === activeApp && x.status === 'Approved').reduce((a,b)=>a+parseInt(b.amount),0); let totalPakai = dbNasabah.filter(x => x.unit === activeApp && x.status === 'Approved').reduce((a,b)=>a+parseInt(b.plafond),0); let sisa = totalMasuk - totalPakai; b.innerHTML = `<div class="card" style="background:${sisa<0?'#ffebee':'#e8f5e9'}"><h3>Sisa Kuota: Rp ${sisa.toLocaleString()}</h3></div><div class="card"><h4>Ajukan Dana</h4><div class="form-vertical"><input id="req-amt" type="number" class="form-control" placeholder="Nominal"><input id="req-desc" class="form-control" placeholder="Keperluan"><button class="btn btn-primary" onclick="reqDana()">Kirim</button></div></div>`; }
            else if(id==='approval') { t.innerText="Approval"; let rows = dbNasabah.filter(x=>x.unit===activeApp && x.status==='Pending').map(x=>`<tr><td>${x.nama}</td><td>Rp ${parseInt(x.plafond).toLocaleString()}</td><td><button class="btn btn-success" onclick="approve('${x.id}', ${x.plafond})">ACC</button></td></tr>`).join(''); b.innerHTML=`<div class="card"><h4>Daftar Pending</h4><div class="table-responsive"><table><thead><tr><th>Nama</th><th>Plafond</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; }
            else if(id==='surat_induk') { t.innerText="Surat Menyurat"; let rows=dbSurat.map(s=>`<tr><td>${s.no}</td><td>${s.jenis}</td><td>${s.tujuan}</td><td><button class="btn btn-sm btn-primary" onclick="printSurat('${s.no}','${s.tujuan}','${s.isi}')">Cetak</button></td></tr>`).join(''); b.innerHTML=`<div class="card"><h4>Buat Surat</h4><div class="form-vertical"><input id="s-tuj" class="form-control" placeholder="Tujuan"><input id="s-per" class="form-control" placeholder="Perihal"><textarea id="s-isi" class="form-control" placeholder="Isi Surat..."></textarea><div style="display:flex;gap:10px"><button class="btn btn-success" onclick="saveSurat('Keluar')">Surat Keluar (Auto No)</button><button class="btn btn-warning" onclick="saveSurat('Masuk')">Log Surat Masuk</button></div></div></div><div class="card"><h4>Arsip</h4><div class="table-responsive"><table><thead><tr><th>No</th><th>Jenis</th><th>Tujuan</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table></div></div><div class="card"><h4>Config No Surat</h4><div class="form-vertical"><label>Kode SPS</label><input id="c-sps" class="form-control" value="${settings.codes.sps}"><label>Kode KMS</label><input id="c-kms" class="form-control" value="${settings.codes.kms}"><label>Kode Gadai</label><input id="c-gadai" class="form-control" value="${settings.codes.gadai}"><button class="btn btn-primary" onclick="saveCodes()">Simpan Kode</button></div></div>`; }
            else if(id==='manage_shu') { t.innerText="SHU"; b.innerHTML=`<div class="card"><div class="form-vertical"><label>Profit</label><input id="sh-p" class="form-control" value="${settings.shu.profit}"><label>% Tetap</label><input id="sh-t" class="form-control" value="${settings.shu.p_tetap}"><label>% Nasabah</label><input id="sh-n" class="form-control" value="${settings.shu.p_nasabah}"><button class="btn btn-primary" onclick="saveSHU()">Simpan</button></div></div>`; }
            else if(id==='sarpras_approval') { t.innerText="Approval Sarpras"; let rows=dbSarpras.map((s,i)=>`<tr><td>${s.unit.toUpperCase()}</td><td>${s.item}</td><td>${s.alasan}</td><td><span class="badge ${s.status=='Pending'?'bg-pending':'bg-success'}">${s.status}</span></td><td>${s.status=='Pending'?`<button class="btn btn-sm btn-success" onclick="accSarpras(${i})">ACC</button>`:''}</td></tr>`).join(''); b.innerHTML=`<div class="card"><h4>Pengajuan Unit</h4><div class="table-responsive"><table><thead><tr><th>Unit</th><th>Item</th><th>Alasan</th><th>Status</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; }
            else if(id==='req_sarpras') { t.innerText="Ajukan Sarpras"; b.innerHTML=`<div class="card"><div class="form-vertical"><input id="sp-i" class="form-control" placeholder="Barang"><input id="sp-a" class="form-control" placeholder="Alasan"><button class="btn btn-primary" onclick="sendSarpras()">Kirim</button></div></div>`; }
            else if(id==='laporan_keuangan') { t.innerText="Laporan Keuangan"; b.innerHTML=`<div class="card"><h3>Cetak Laporan Keuangan Unit</h3><div style="display:flex;gap:10px"><button class="btn btn-primary" onclick="printLaporanKeuangan('sps')">Laporan SPS</button><button class="btn btn-warning" onclick="printLaporanKeuangan('kms')">Laporan KMS</button><button class="btn btn-danger" onclick="printLaporanKeuangan('gadai')">Laporan Gadai</button></div></div>`; }
            else if(id==='setting_margin') { t.innerText="Margin"; b.innerHTML=`<div class="card"><div class="form-vertical"><label>Margin %</label><input id="u-mar" class="form-control" value="${settings.margins[activeApp]}"><button class="btn btn-primary" onclick="saveMargin()">Simpan</button></div></div>`; }
            else if(id==='cetak') { t.innerText="Cetak"; let rows=dbNasabah.filter(x=>x.unit===activeApp && x.status==='Approved').map(x=>`<tr><td>${x.nama}</td><td>${x.noSurat}</td><td><button class="btn btn-primary btn-sm" onclick="printAkad(${x.id})">Cetak</button></td></tr>`).join(''); b.innerHTML=`<div class="card"><div class="table-responsive"><table>${rows}</table></div></div>`; }
            else if(id==='billing') { t.innerText="Billing"; let rows=dbNasabah.filter(x=>x.unit===activeApp && x.status==='Approved').map(x=>`<tr><td>${x.nama}</td><td>${x.payStatus}</td><td><button class="btn btn-warning" onclick="window.open('https://wa.me/${x.wa}')">Tagih</button> <button class="btn btn-success" onclick="bayar(${x.id})">Bayar</button></td></tr>`).join(''); b.innerHTML=`<div class="card"><div class="table-responsive"><table>${rows}</table></div></div>`; }
            else if(id==='config_surat') { t.innerText="Config Surat"; b.innerHTML=`<div class="card"><div class="form-vertical"><label>Kode SPS</label><input id="c-sps" class="form-control" value="${settings.codes.sps}"><label>Kode KMS</label><input id="c-kms" class="form-control" value="${settings.codes.kms}"><label>Kode Gadai</label><input id="c-gadai" class="form-control" value="${settings.codes.gadai}"><button class="btn btn-primary" onclick="saveCodes()">Simpan</button></div></div>`; }
            else { b.innerHTML=`<div class="card">Fitur Aktif</div>`; }
        }

        // --- ACTIONS ---
        let tempFoto = '';
        function readFoto(i) { if(i.files[0]){let r=new FileReader(); r.onload=e=>tempFoto=e.target.result; r.readAsDataURL(i.files[0]);} }
        function previewImage(input, targetId) { if(input.files[0]) { let r = new FileReader(); r.onload = function(e) { document.getElementById(targetId).value = e.target.result; }; r.readAsDataURL(input.files[0]); } }
        
        function saveID() { 
            settings.nama=document.getElementById('s-nm').value; settings.izin=document.getElementById('s-iz').value; 
            settings.alamat=document.getElementById('s-al').value; settings.email=document.getElementById('s-em').value; 
            settings.wa=document.getElementById('s-wa').value; settings.logo=document.getElementById('s-lg').value;
            settings.wallpaper=document.getElementById('s-wall').value;
            renderIdentitas(); saveToCloud(); alert('Identitas Tersimpan!'); 
        }
        function saveSHU() { settings.shu.profit=document.getElementById('sh-p').value; settings.shu.p_tetap=document.getElementById('sh-t').value; settings.shu.p_nasabah=document.getElementById('sh-n').value; saveToCloud(); alert('Saved'); }
        function saveCodes() { settings.codes.sps=document.getElementById('c-sps').value; settings.codes.kms=document.getElementById('c-kms').value; settings.codes.gadai=document.getElementById('c-gadai').value; saveToCloud(); alert('Saved'); }
        function saveMargin() { settings.margins[activeApp]=document.getElementById('u-mar').value; saveToCloud(); alert('Saved'); }
        function saveAllTemplates() { settings.templates.sps = document.getElementById('t-sps').value; settings.templates.kms = document.getElementById('t-kms').value; settings.templates.gadai = document.getElementById('t-gadai').value; saveToCloud(); alert('Template Tersimpan!'); }
        function addUser() { let u=document.getElementById('n-u').value; let r=document.getElementById('n-r').value; let p=document.getElementById('n-p').value; if(!u||!p)return alert("Wajib!"); let a=['admin','bendahara','sekretaris','anggota'].includes(r)?'induk':'unit'; dbUsers.push({user:u, role:r, app:a, password:p}); saveToCloud(); alert('User Ditambah'); page('users'); }
        function delUser(i) { dbUsers.splice(i,1); saveToCloud(); page('users'); }
        function subNas() { let d = {id:Date.now(), unit:activeApp, nama:document.getElementById('i-nm').value, nik:document.getElementById('i-nik').value, alamat:document.getElementById('i-al').value, wa:document.getElementById('i-wa').value, email:document.getElementById('i-em').value, plafond:document.getElementById('i-pl').value, tenor:document.getElementById('i-tn').value, dp:document.getElementById('i-dp')?.value||0, jaminan: document.getElementById('i-jam')?.value||'-', status:'Pending', payStatus:'Belum', noSurat:'-', foto:tempFoto}; dbNasabah.push(d); saveToCloud(); alert('Nasabah Tersimpan'); page('input'); }
        function approve(id, nominal) { 
            let masuk = dbDana.filter(x => x.unit === activeApp && x.status === 'Approved').reduce((a,b)=>a+parseInt(b.amount),0); 
            let keluar = dbNasabah.filter(x => x.unit === activeApp && x.status === 'Approved').reduce((a,b)=>a+parseInt(b.plafond),0); 
            let limitPersen = settings.limits[activeApp] || 100; 
            if(keluar + parseInt(nominal) > masuk * (limitPersen / 100)) return alert(`GAGAL! Dana melebihi limit ${limitPersen}%.`); 
            let i=dbNasabah.findIndex(x=>x.id==id); dbNasabah[i].status='Approved'; dbNasabah[i].noSurat=`BIMA/${settings.codes[activeApp]}/${Math.floor(Math.random()*1000)}/2026`; 
            saveToCloud(); page('approval'); 
        }
        function saveModal(st) { let u = document.getElementById('m-unit').value; let a = document.getElementById('m-amount').value; dbDana.push({id: Date.now(), date: Date.now(), unit: u, amount: a, status: st, desc: document.getElementById('m-desc').value}); saveToCloud(); alert('Dana Disimpan'); page('distribusi_modal'); }
        function saveLimits() { settings.limits.sps = document.getElementById('lim-sps').value; settings.limits.kms = document.getElementById('lim-kms').value; settings.limits.gadai = document.getElementById('lim-gadai').value; saveToCloud(); alert('Limit Dikunci'); }
        function accDana(id) { let i = dbDana.findIndex(d=>d.id==id); dbDana[i].status='Approved'; saveToCloud(); page('distribusi_modal'); }
        function reqDana() { dbDana.push({id: Date.now(), date: Date.now(), unit: activeApp, amount: document.getElementById('req-amt').value, status: 'Pending', desc: document.getElementById('req-desc').value}); saveToCloud(); alert('Terkirim'); page('dana_unit'); }
        function doPresensi(type) { let h = new Date().getHours(); if (type === 'Masuk' && (h < 8 || h >= 14)) return alert("Absen Masuk hanya jam 08:00 - 14:00"); if (type === 'Pulang' && h < 14) return alert("Belum waktunya pulang (14:00)"); let ket = type === 'Izin' ? (document.getElementById('p-status').value + ": " + document.getElementById('p-ket').value) : '-'; let loc = "Lokasi: -8.123, 112.456 (Kantor)"; dbPresensi.push({ time: Date.now(), user: activeUser.user, role: activeUser.role, type: type, loc: loc, ket: ket }); saveToCloud(); alert("Presensi Berhasil"); }
        function saveProfilLembaga() { settings.visi = document.getElementById('e-visi').value; settings.misi = document.getElementById('e-misi').value; settings.struktur.ketua = document.getElementById('e-ketua').value; settings.struktur.sekretaris = document.getElementById('e-sekretaris').value; settings.struktur.bendahara = document.getElementById('e-bendahara').value; settings.unit_leads = { sps: document.getElementById('e-u-sps').value, kms: document.getElementById('e-u-kms').value, gadai: document.getElementById('e-u-gadai').value }; saveToCloud(); alert('Profil Tersimpan!'); page('home'); }
        function sendSarpras() { dbSarpras.push({unit:activeApp, item:document.getElementById('sp-i').value, alasan:document.getElementById('sp-a').value, status:'Pending'}); saveToCloud(); alert('Terkirim'); }
        function accSarpras(i) { dbSarpras[i].status='Approved'; saveToCloud(); page('sarpras_approval'); }
        function saveSurat(j) { let n=j==='Keluar'?`BIMA/SK/${Math.floor(Math.random()*1000)}/2026`:'-'; dbSurat.push({no:n, jenis:j, tujuan:document.getElementById('s-tuj').value, perihal:document.getElementById('s-per').value, isi:document.getElementById('s-isi').value}); saveToCloud(); alert('Saved '+n); page('surat_induk'); }
        function bayar(id) { let i=dbNasabah.findIndex(x=>x.id===id); dbNasabah[i].payStatus='Lunas'; saveToCloud(); alert('Lunas'); page('billing'); }

        // --- PRINT ENGINE ---
        function printLaporanPenyaluran() { let rows = dbDana.filter(d=>d.status==='Approved').map(d=>`<tr><td>${new Date(d.date).toLocaleDateString()}</td><td>${d.unit.toUpperCase()}</td><td>Rp ${parseInt(d.amount).toLocaleString()}</td><td>${d.desc}</td></tr>`).join(''); let html = `<div class="paper"><div class="bank-header"><img src="${settings.logo}" class="bank-logo"><div class="bank-info"><h1>${settings.nama}</h1><p>LAPORAN PENYALURAN MODAL</p></div></div><div class="doc-body"><br><table class="fin-table"><thead><tr><th>Tanggal</th><th>Unit Penerima</th><th>Nominal</th><th>Keterangan</th></tr></thead><tbody>${rows}</tbody></table><br><br><div style="text-align:right">Bendahara BMT</div></div></div>`; document.getElementById('printable-area').innerHTML = html; setTimeout(() => window.print(), 500); }
        function printSurat(no, tuj, isi) { let c = `<div class="paper"><div class="bank-header"><img src="${settings.logo}" class="bank-logo"><div class="bank-info"><h1>${settings.nama}</h1><p>${settings.alamat}<br>Izin: ${settings.izin} | Email: ${settings.email}</p></div></div><div style="text-align:right">${new Date().toLocaleDateString()}</div><p>Nomor: ${no}</p><p>Kepada Yth,<br><b>${tuj}</b></p><br><div class="doc-body">${isi.replace(/\n/g,'<br>')}</div><br><br><div style="text-align:right; margin-top:50px;"><p>Hormat Kami,</p><br><br><br><p>Sekretaris / Admin</p></div></div>`; document.getElementById('printable-area').innerHTML = c; setTimeout(() => window.print(), 500); }
        function printLaporanKeuangan(unit) { let data = dbNasabah.filter(x => x.unit === unit); let total = data.reduce((a,b) => a + parseInt(b.plafond), 0); let rows = data.map((d,i) => `<tr><td>${i+1}</td><td>${d.nama}</td><td>${d.noSurat}</td><td>Rp ${parseInt(d.plafond).toLocaleString()}</td><td>${d.payStatus}</td></tr>`).join(''); let html = `<div class="paper"><div class="bank-header"><img src="${settings.logo}" class="bank-logo"><div class="bank-info"><h1>${settings.nama}</h1><p>LAPORAN KEUANGAN UNIT ${unit.toUpperCase()}</p></div></div><div class="doc-body"><br><table class="fin-table"><thead><tr><th>No</th><th>Nama</th><th>No. Akad</th><th>Plafond</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table><br><b>Total Pembiayaan: Rp ${total.toLocaleString()}</b><br><br><div style="text-align:right">Bendahara BMT</div></div></div>`; document.getElementById('printable-area').innerHTML = html; setTimeout(() => window.print(), 500); }
        function printLaporanSarpras() { let rows = dbSarpras.map((s,i) => `<tr><td>${i+1}</td><td>${s.unit.toUpperCase()}</td><td>${s.item}</td><td>${s.alasan}</td><td>${s.status}</td></tr>`).join(''); let html = `<div class="paper"><div class="bank-header"><img src="${settings.logo}" class="bank-logo"><div class="bank-info"><h1>${settings.nama}</h1><p>LAPORAN PENGAJUAN SARPRAS</p></div></div><div class="doc-body"><table class="fin-table"><thead><tr><th>No</th><th>Unit</th><th>Barang</th><th>Alasan</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table><br><br><div style="text-align:right">Sekretaris BMT</div></div></div>`; document.getElementById('printable-area').innerHTML = html; setTimeout(() => window.print(), 500); }
        function printDatabaseNasabah() { let rows = dbNasabah.map((d,i) => `<tr><td>${i+1}</td><td>${d.unit.toUpperCase()}</td><td>${d.nama}</td><td>${d.nik}</td><td>${d.wa}</td><td>Rp ${parseInt(d.plafond).toLocaleString()}</td></tr>`).join(''); let html = `<div class="paper"><div class="bank-header"><img src="${settings.logo}" class="bank-logo"><div class="bank-info"><h1>${settings.nama}</h1><p>DATABASE NASABAH</p></div></div><div class="doc-body"><table class="fin-table"><thead><tr><th>No</th><th>Unit</th><th>Nama</th><th>NIK</th><th>WA</th><th>Plafond</th></tr></thead><tbody>${rows}</tbody></table><br><br><div style="text-align:right">Sekretaris BMT</div></div></div>`; document.getElementById('printable-area').innerHTML = html; setTimeout(() => window.print(), 500); }
        function printLaporanPresensi() { let rows = dbPresensi.map(p => `<tr><td>${new Date(p.time).toLocaleString()}</td><td>${p.user}</td><td>${p.type}</td><td>${p.ket||'-'}</td></tr>`).join(''); let html = `<div class="paper"><div class="bank-header"><img src="${settings.logo}" class="bank-logo"><div class="bank-info"><h1>${settings.nama}</h1><p>LAPORAN PRESENSI PEGAWAI</p></div></div><div class="doc-body"><table class="fin-table"><thead><tr><th>Waktu</th><th>Nama Pegawai</th><th>Status</th><th>Keterangan</th></tr></thead><tbody>${rows}</tbody></table><br><br><div style="text-align:right">Sekretaris BMT</div></div></div>`; document.getElementById('printable-area').innerHTML = html; setTimeout(() => window.print(), 500); }
        function printIDCard(user, role) { let html = `<div class="id-card-print"><div class="id-card" style="display:block;"><div class="id-header">${settings.nama.toUpperCase()}</div><div class="id-body"><div class="id-photo"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" style="width:100%;height:100%;"></div><div class="id-details"><b style="font-size:12pt">${user}</b><br><span>${role.toUpperCase()}</span><br><span>ID: ${Math.floor(Math.random()*100000)}</span><br><br><img class="barcode" src="https://lindell.me/JsBarcode/images/barcode.png"></div></div><div class="id-footer" style="font-size:7pt;">Kartu Identitas Pegawai Resmi</div></div></div>`; document.getElementById('printable-area').innerHTML = html; setTimeout(() => window.print(), 500); }

        function printAkad(id) {
            let d = dbNasabah.find(x => x.id == id);
            let uName = d.unit==='sps'?'SIMPAN PINJAM':(d.unit==='kms'?'KREDIT MOTOR':'GADAI');
            let tpl = d.unit==='sps'?settings.templates.sps:(d.unit==='kms'?settings.templates.kms:settings.templates.gadai);
            let margin = parseInt(d.plafond) * (settings.margins[d.unit]/100);
            let totalTotal = parseInt(d.plafond) + margin;
            let angsuran = totalTotal / parseInt(d.tenor);
            let extra = d.unit==='kms' ? `<tr><td>Uang Muka (DP)</td><td>Rp ${parseInt(d.dp).toLocaleString()}</td></tr>` : (d.unit==='gadai' ? `<tr><td>Jaminan</td><td>${d.jaminan}</td></tr>` : '');
            
            let html = `
            <div class="paper">
                <div class="bank-header"><img src="${settings.logo}" class="bank-logo"><div class="bank-info"><h1>${settings.nama}</h1><p>${settings.alamat}</p><p>Izin: ${settings.izin} | WA: ${settings.wa} | Email: ${settings.email}</p></div></div>
                <div class="doc-title"><h2>SURAT PERJANJIAN AKAD ${uName}</h2><p>Nomor: ${d.noSurat}</p></div>
                <div class="doc-body">
                    <p>Pada hari ini, tanggal ${new Date().toLocaleDateString()}, yang bertanda tangan di bawah ini:</p>
                    <div class="bio-container"><div class="photo-frame"><img src="${d.foto || ''}" alt="FOTO"></div><div class="bio-text"><table><tr><td width="130">Nama Lengkap</td><td>: <b>${d.nama}</b></td></tr><tr><td>NIK</td><td>: ${d.nik}</td></tr><tr><td>Alamat</td><td>: ${d.alamat}</td></tr><tr><td>No. Telepon</td><td>: ${d.wa}</td></tr></table></div></div>
                    <p>Selanjutnya disebut sebagai <b>PIHAK PERTAMA (Nasabah)</b>.</p><p>Bertindak mewakili <b>${settings.nama}</b>, selanjutnya disebut <b>PIHAK KEDUA (BMT)</b>.</p>
                    <p>Kedua belah pihak menyepakati akad pembiayaan dengan rincian:</p>
                    <table class="fin-table"><tr><td>Plafond</td><td>Tenor</td><td>Margin/Jasa</td><td>Angsuran/Bln</td></tr><tr><td><b>Rp ${parseInt(d.plafond).toLocaleString()}</b></td><td>${d.tenor} Bulan</td><td>Rp ${margin.toLocaleString()}</td><td><b>Rp ${angsuran.toLocaleString()}</b></td></tr>${extra}</table>
                    <div class="clauses"><b>PASAL - PASAL PERJANJIAN:</b><br>${tpl.replace(/\n/g, '<br>')}</div>
                    <div class="signatures">
                        <div class="sig-box"><p>PIHAK PERTAMA<br>(Nasabah)</p><div class="sig-line">(${d.nama})</div></div>
                        <div class="sig-box"><p>SAKSI<br>(Marketing)</p><div class="sig-line">(....................)</div></div>
                        <div class="sig-box"><p>PIHAK KEDUA<br>(Manager Unit)</p><div class="sig-line">(....................)</div></div>
                    </div>
                </div>
            </div>`;
            document.getElementById('printable-area').innerHTML = html; setTimeout(() => window.print(), 500);
        }
    </script>
</body>
</html>